---
import Layout from '../../layouts/Layout.astro'
import Icons from '../../components/Icons.astro'
import { fetchBlogs, fetchBlogBySlug, getStrapiOptimizedImage } from '../../lib/strapi'
import type { Blog } from '../../types/strapi'

// Generar rutas estáticas para todos los blogs
export async function getStaticPaths() {
  // Obtener todos los blogs con paginación eficiente
  let allBlogs: Blog[] = []
  let currentPage = 1
  let hasMore = true
  
  // Fetch en batches de 25 (más rápido que 100 de una vez)
  while (hasMore) {
    const { data: blogs, meta } = await fetchBlogs({ page: currentPage, pageSize: 25 })
    allBlogs = [...allBlogs, ...blogs as Blog[]]
    
    hasMore = currentPage < meta.pagination.pageCount
    currentPage++
  }
  
  return allBlogs.map((blog) => ({
    params: { slug: blog.slugBlogs },
  }))
}

const { slug } = Astro.params

if (!slug) {
  return Astro.redirect('/blog')
}

const blog = await fetchBlogBySlug(slug) as Blog | null

if (!blog) {
  return Astro.redirect('/blog')
}

const { tituloBlog, descripcionBlog, contenidoBlog, imgPortadaBlog, FechaDePublicacion, TiempoEstimado, blog: categorias, autor } = blog

// Imagen de portada - usar formato 'large' para hero (más grande pero optimizado)
const imageUrl = getStrapiOptimizedImage(imgPortadaBlog, 'large')
// Thumbnail para placeholder (carga instantánea)
const imagePlaceholder = getStrapiOptimizedImage(imgPortadaBlog, 'thumbnail')

// Autor - usar formato 'thumbnail' para avatar
let autorNombre = 'Vivir IPS'
let autorAvatar: string | null = null
let autorRol = ''
let autorBio = ''
if (autor && (autor as any).nombreAutor) {
  autorNombre = (autor as any).nombreAutor
  autorRol = (autor as any).rolAutor || ''
  autorBio = (autor as any).biografia || ''
  if ((autor as any).avatar) {
    autorAvatar = getStrapiOptimizedImage((autor as any).avatar, 'thumbnail')
  }
}

// Categoría
let categoria: { name: string; color: string } | null = null
if (categorias && (categorias as any)[0]) {
  categoria = {
    name: (categorias as any)[0].NombreCategoria,
    color: (categorias as any)[0].color
  }
}

// Fecha
const fecha = new Date(FechaDePublicacion).toLocaleDateString('es-ES', { 
  year: 'numeric',
  month: 'long', 
  day: 'numeric'
})
---

<Layout 
  title={`${tituloBlog} | Vivir IPS`}
  description={descripcionBlog}
  image={imageUrl}
>
  <!-- Hero con imagen de portada -->
  <div class="relative w-full h-[400px] md:h-[500px] lg:h-[600px] overflow-hidden bg-gray-900">
    <img 
      src={imageUrl} 
      alt={tituloBlog}
      class="absolute inset-0 w-full h-full object-cover opacity-60 hero-image"
      style={`background-image: url(${imagePlaceholder}); background-size: cover; background-position: center;`}
      loading="eager"
      fetchpriority="high"
      decoding="async"
    />
    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>
    
    {/* Contenido del hero */}
    <div class="relative h-full max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col justify-end pb-12 md:pb-16 lg:pb-20">
      {/* Categoría */}
      {categoria && (
        <span 
          class="inline-block px-4 py-2 rounded-full text-white text-sm font-semibold mb-4 w-fit"
          style={`background-color: ${categoria.color}`}
        >
          {categoria.name}
        </span>
      )}
      
      {/* Título */}
      <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-white mb-4 leading-tight">
        {tituloBlog}
      </h1>
      
      {/* Meta info */}
      <div class="flex flex-wrap items-center gap-4 text-white/90 text-sm sm:text-base">
        <div class="flex items-center gap-2">
          {autorAvatar ? (
            <img 
              src={autorAvatar} 
              alt={autorNombre}
              class="w-10 h-10 rounded-full object-cover border-2 border-white/20"
              loading="lazy"
              decoding="async"
            />
          ) : (
            <div class="w-10 h-10 rounded-full bg-[#19b8e9] text-white flex items-center justify-center font-semibold border-2 border-white/20">
              {autorNombre.charAt(0)}
            </div>
          )}
          <span class="font-medium">{autorNombre}</span>
        </div>
        
        <span class="hidden sm:inline text-white/40">•</span>
        
        <time datetime={FechaDePublicacion} class="flex items-center gap-2">
          <Icons name="calendar" width={16} height={16} />
          {fecha}
        </time>
        
        <span class="hidden sm:inline text-white/40">•</span>
        
        <span class="flex items-center gap-2">
          <Icons name="clock" width={16} height={16} />
          {TiempoEstimado} min de lectura
        </span>
      </div>
    </div>
  </div>

  {/* Contenido del artículo */}
  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-16 lg:py-20">
    {/* Descripción destacada */}
    <div class="mb-8 md:mb-12">
      <p class="text-xl md:text-2xl text-gray-700 leading-relaxed font-light border-l-4 border-[#19b8e9] pl-6 py-2">
        {descripcionBlog}
      </p>
    </div>

    {/* Contenido principal */}
    <div class="prose prose-lg max-w-none
      prose-headings:font-bold prose-headings:text-[#0e3551]
      prose-h2:text-2xl prose-h2:md:text-3xl prose-h2:mt-12 prose-h2:mb-4
      prose-h3:text-xl prose-h3:md:text-2xl prose-h3:mt-8 prose-h3:mb-3
      prose-p:text-gray-700 prose-p:leading-relaxed prose-p:mb-6
      prose-a:text-[#19b8e9] prose-a:no-underline hover:prose-a:underline
      prose-strong:text-[#0e3551] prose-strong:font-semibold
      prose-ul:my-6 prose-li:my-2
      prose-img:rounded-lg prose-img:shadow-lg
    " id="blog-content" style="content-visibility: auto;">
      <div set:html={contenidoBlog} />
    </div>

    {/* Separador */}
    <div class="my-12 md:my-16 border-t border-gray-200"></div>

    {/* Información del autor */}
    <div class="bg-gradient-to-br from-gray-50 to-blue-50/30 rounded-2xl p-6 md:p-8 border border-gray-100">
      <h3 class="text-lg font-bold text-[#0e3551] mb-4">Sobre el Autor</h3>
      
      <div class="flex items-start gap-4 md:gap-6">
        {autorAvatar ? (
          <img 
            src={autorAvatar} 
            alt={autorNombre}
            class="w-16 h-16 md:w-20 md:h-20 rounded-full object-cover flex-shrink-0 border-4 border-white shadow-md"
            loading="lazy"
            decoding="async"
          />
        ) : (
          <div class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-[#19b8e9] text-white flex items-center justify-center text-2xl font-bold flex-shrink-0 border-4 border-white shadow-md">
            {autorNombre.charAt(0)}
          </div>
        )}
        
        <div class="flex-1 min-w-0">
          <h4 class="text-lg md:text-xl font-bold text-[#0e3551] mb-1">
            {autorNombre}
          </h4>
          {autorRol && (
            <p class="text-sm md:text-base text-[#19b8e9] font-medium mb-3">
              {autorRol}
            </p>
          )}
          {autorBio && (
            <p class="text-sm md:text-base text-gray-600 leading-relaxed">
              {autorBio}
            </p>
          )}
        </div>
      </div>
    </div>

    {/* Botón volver */}
    <div class="mt-12 md:mt-16">
      <a 
        href="/blog"
        class="inline-flex items-center gap-2 px-6 py-3 bg-[#0e3551] text-white font-semibold rounded-lg hover:bg-[#19b8e9] transition-colors duration-300 shadow-md hover:shadow-lg"
      >
        <Icons name="arrow-left" width={20} height={20} />
        Volver al Blog
      </a>
    </div>
  </article>
</Layout>

<style>
  /* Hero image con progressive loading */
  .hero-image {
    transition: opacity 0.3s ease-in-out;
    will-change: opacity;
  }
  
  /* Imágenes del contenido con lazy loading smooth */
  article :global(.content-image) {
    opacity: 0;
    transition: opacity 0.4s ease-in-out;
    will-change: opacity;
  }
  
  article :global(.content-image[loading="lazy"]) {
    opacity: 1;
  }
  
  /* Estilos adicionales para el contenido HTML */
  article :global(img) {
    margin-top: 2rem;
    margin-bottom: 2rem;
  }
  
  article :global(blockquote) {
    border-left: 4px solid #19b8e9;
    padding-left: 1.5rem;
    font-style: italic;
    color: #4b5563;
    margin: 2rem 0;
  }
  
  article :global(code) {
    background: #f3f4f6;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.9em;
    color: #0e3551;
  }
  
  article :global(pre) {
    background: #1f2937;
    color: #f9fafb;
    padding: 1.5rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 2rem 0;
  }
  
  article :global(pre code) {
    background: transparent;
    padding: 0;
    color: inherit;
  }
</style>

<script is:inline>
  // Optimizar imágenes del contenido - diferido para mejor FCP
  window.addEventListener('load', () => {
    requestIdleCallback(() => {
      const contentImages = document.querySelectorAll('#blog-content img');
      
      contentImages.forEach((img) => {
        // Agregar lazy loading a todas las imágenes del contenido
        img.setAttribute('loading', 'lazy');
        img.setAttribute('decoding', 'async');
        
        // Agregar clase para transiciones smooth
        img.classList.add('content-image');
      });
    });
  });
</script>
